<!-- 文件名建议保存为 index.html -->
<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>进销存管理系统</title>
  <script src="https://cdn.jsdelivr.net/npm/vue@3.4.21/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    /* 样式略，无需改动（与之前一致） */
    body {
      font-family: "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(to right, #f0f2f5, #d6e4f0);
      color: #333;
    }
    nav { background: #3f51b5; color: white; padding: 10px; display: flex; gap: 10px; }
    nav button { background: #5c6bc0; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; transition: all 0.3s ease; }
    nav button:hover { background: #7986cb; }
    .active { background: #1a237e; }
    .container { padding: 20px; animation: fadeIn 0.5s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
    input, select, button, textarea {
      margin: 5px 0;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      width: 100%;
      max-width: 300px;
      box-sizing: border-box;
    }
    button.export { background: #4caf50; color: white; border: none; padding: 8px 12px; cursor: pointer; margin-top: 10px; }
    button.small { padding: 4px 8px; margin-left: 5px; font-size: 12px; }
    h2, h3 { color: #2c3e50; }
    .summary-table { margin-top: 20px; background-color: #f9f9f9; }
  </style>
</head>
<body>
<div id="app">
  <nav>
    <button :class="{active: view==='entry'}" @click="view='entry'">入库</button>
    <button :class="{active: view==='exit'}" @click="view='exit'">出库</button>
    <button :class="{active: view==='inventory'}" @click="view='inventory'">库存盘点</button>
    <button :class="{active: view==='records'}" @click="view='records'">出入库记录查询</button>
    <button :class="{active: view==='products'}" @click="view='products'">示例商品管理</button>
  </nav>

  <!-- 产品管理 -->
  <div class="container" v-if="view==='products'">
    <h2>添加/修改示例商品</h2>
    <div>
      <input v-model="newProduct.name" placeholder="名称">
      <input v-model="newProduct.spec" placeholder="规格">
      <input v-model="newProduct.color" placeholder="颜色">
      <button @click="saveProduct">{{ newProduct.id ? '更新' : '保存' }}</button>
    </div>
    <h3>示例商品列表</h3>
    <ul>
      <li v-for="p in products" :key="p.id">
        {{ p.name }} / {{ p.spec }} / {{ p.color }}
        <button class="small" @click="editProduct(p)">编辑</button>
        <button class="small" @click="deleteProduct(p.id)">删除</button>
      </li>
    </ul>
  </div>

  <!-- 出入库 -->
  <div class="container" v-if="view==='entry' || view==='exit'">
    <h2>{{ view === 'entry' ? '入库操作' : '出库操作' }}</h2>
    <select v-model="selectedProductId">
      <option disabled value="">选择商品</option>
      <option v-for="p in products" :value="p.id">{{ p.name }} / {{ p.spec }} / {{ p.color }}</option>
    </select>
    <input v-model="weightInput" placeholder="重量，逗号隔开">
    <input v-model="countInput" placeholder="件数">
    <input v-model="recordTime" type="date">
    <input v-if="view==='exit'" v-model="buyerInput" placeholder="购买商家">
    <button @click="record(view === 'entry' ? '入库' : '出库')">提交</button>
    <h3>导入表格进行{{ view === 'entry' ? '入库' : '出库' }}</h3>
    <input type="file" @change="handleFileUpload($event, view === 'entry' ? '入库' : '出库')">
    <p>要求表头包含：名称,规格,颜色,重量,件数,时间（出库时可加：购买商家）</p>
  </div>

  <!-- 库存盘点 -->
  <div class="container" v-if="view==='inventory'">
    <h2>库存盘点</h2>
    <table>
      <thead><tr><th>名称</th><th>规格</th><th>颜色</th><th>总重量</th><th>总件数</th></tr></thead>
      <tbody>
        <tr v-for="inv in inventory">
          <td>{{ inv.name }}</td>
          <td>{{ inv.spec }}</td>
          <td>{{ inv.color }}</td>
          <td>{{ inv.totalWeight .toFixed(2)}}</td>
          <td>{{ inv.totalCount.toFixed(2) }}</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- 出入库记录查询 -->
  <div class="container" v-if="view==='records'">
    <h2>出入库记录查询</h2>
    <input v-model="searchQuery" placeholder="输入关键词，空格或逗号隔开模糊搜索">
    <small>将在所有字段中进行模糊匹配</small>
<div style="margin-top:10px;">
  <label>起始日期：<input type="date" v-model="startDate"></label>
  <label>结束日期：<input type="date" v-model="endDate"></label>
</div>
    <div style="margin-top:10px;">
      <button class="export" @click="exportToExcel">导出记录为 Excel</button>
      <button class="export" @click="exportAll">导出全部数据</button>
      <input type="file" @change="importAll" accept=".xlsx">
    </div>
    <table>
      <thead>
        <tr>
          <th>类型</th><th>名称</th><th>规格</th><th>颜色</th>
          <th>重量</th><th>件数</th><th>时间</th><th>购买商家</th><th>操作</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="(r, i) in filteredRecords" :key="i">
          <td>{{ r.type }}</td>
          <td>{{ r.name }}</td>
          <td>{{ r.spec }}</td>
          <td>{{ r.color }}</td>
          <td>{{ r.weight }}</td>
          <td>{{ r.count }}</td>
          <td>{{ r.time }}</td>
          <td>{{ r.buyer || '' }}</td>
          <td>
            <button class="small" @click="editRecord(i)">编辑</button>
            <button class="small" @click="deleteRecord(i)">删除</button>
          </td>
        </tr>
      </tbody>
    </table>

    <h3>统计汇总</h3>
    <table class="summary-table">
      <thead><tr><th>名称</th><th>规格</th><th>颜色</th><th>总重量</th><th>总件数</th></tr></thead>
      <tbody>
        <tr v-for="s in summary">
          <td>{{ s.name }}</td>
          <td>{{ s.spec }}</td>
          <td>{{ s.color }}</td>
          <td>{{ s.totalWeight.toFixed(2) }}</td>
          <td>{{ s.totalCount.toFixed(2) }}</td>
        </tr>
        <tr style="font-weight:bold;">
          <td colspan="3">合计</td>
          <td>{{ totalWeight .toFixed(2)}}</td>
          <td>{{ totalCount.toFixed(2) }}</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<script>
const { createApp } = Vue;
createApp({
  data() {
    return {
      view: 'entry',
      products: JSON.parse(localStorage.getItem('products') || '[]'),
      newProduct: { name: '', spec: '', color: '', id: null },
      selectedProductId: '',
      weightInput: '',
      countInput: '',
      recordTime: '',
      buyerInput: '',
      records: JSON.parse(localStorage.getItem('records') || '[]'),
      searchQuery: '',
      startDate: '',
      endDate: '',

    };
  },
  computed: {
    inventory() {
      const summary = {};
      this.records.forEach(r => {
        const key = r.name + r.spec + r.color;
        const sign = r.type === '入库' ? 1 : -1;
        if (!summary[key]) {
          summary[key] = { name: r.name, spec: r.spec, color: r.color, totalWeight: 0, totalCount: 0 };
        }
        summary[key].totalWeight += sign * parseFloat(r.weight);
        summary[key].totalCount += sign * parseInt(r.count);
      });
      return Object.values(summary);
    },
    filteredRecords() {
  const query = this.searchQuery.trim().toLowerCase();
  const keywords = query.split(/[\s,，]+/).filter(Boolean);

  return this.records.filter(r => {
    const matchKeyword = keywords.length === 0 || keywords.every(k => Object.values(r).join(' ').toLowerCase().includes(k));
    const matchDate =
      (!this.startDate || r.time >= this.startDate) &&
      (!this.endDate || r.time <= this.endDate);
    return matchKeyword && matchDate;
  });
},
    summary() {
      const group = {};
      this.filteredRecords.forEach(r => {
        const key = r.name + r.spec + r.color;
        if (!group[key]) {
          group[key] = { name: r.name, spec: r.spec, color: r.color, totalWeight: 0, totalCount: 0 };
        }
        group[key].totalWeight += parseFloat(r.weight);
        group[key].totalCount += parseInt(r.count);
      });
      return Object.values(group);
    },
    totalWeight() {
      return this.summary.reduce((sum, s) => sum + s.totalWeight, 0);
    },
    totalCount() {
      return this.summary.reduce((sum, s) => sum + s.totalCount, 0);
    }
  },
  methods: {
    saveProduct() {
      const { name, spec, color, id } = this.newProduct;
      if (!name || !spec || !color) return alert("请填写完整");
      if (id) {
        const index = this.products.findIndex(p => p.id === id);
        if (index !== -1) this.products[index] = { ...this.newProduct };
      } else {
        this.products.push({ ...this.newProduct, id: Date.now() });
      }
      this.newProduct = { name: '', spec: '', color: '', id: null };
      this.saveData();
    },
    editProduct(p) { this.newProduct = { ...p }; },
    deleteProduct(id) {
      if (confirm('确认删除该商品？')) {
        this.products = this.products.filter(p => p.id !== id);
        this.saveData();
      }
    },
    record(type) {
      const product = this.products.find(p => p.id === this.selectedProductId);
      if (!product || !this.weightInput || !this.countInput || !this.recordTime) return alert("请填写完整");
      const weights = this.weightInput.split(',').map(w => w.trim()).filter(Boolean);
      weights.forEach(weight => {
        this.records.push({
          type,
          name: product.name,
          spec: product.spec,
          color: product.color,
          weight,
          count: this.countInput,
          time: this.recordTime,
          ...(type === '出库' ? { buyer: this.buyerInput } : {})
        });
      });
      this.weightInput = this.countInput = this.buyerInput = '';
      this.saveData();
    },
    handleFileUpload(event, type) {
      const file = event.target.files[0];
      const reader = new FileReader();
      reader.onload = (e) => {
        const workbook = XLSX.read(e.target.result, { type: 'binary' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet);
        rows.forEach(row => {
          if (row["名称"] && row["规格"] && row["颜色"] && row["重量"] && row["件数"] && row["时间"]) {
            this.records.push({
              type,
              name: row["名称"],
              spec: row["规格"],
              color: row["颜色"],
              weight: row["重量"],
              count: row["件数"],
              time: row["时间"],
              buyer: row["购买商家"] || ''
            });
            const exists = this.products.some(p => p.name === row["名称"] && p.spec === row["规格"] && p.color === row["颜色"]);
            if (!exists) {
              this.products.push({ name: row["名称"], spec: row["规格"], color: row["颜色"], id: Date.now() + Math.random() });
            }
          }
        });
        this.saveData();
        alert("导入完成");
      };
      reader.readAsBinaryString(file);
    },
    exportToExcel() {
  const enriched = this.filteredRecords.map(r => ({
    类型: r.type,
    名称: r.name,
    规格: r.spec,
    颜色: r.color,
    重量: r.weight,
    件数: r.count,
    时间: r.time,
    购买商家: r.buyer || ''
  }));

  const summaryData = this.summary.map(s => ({
    名称: s.name,
    规格: s.spec,
    颜色: s.color,
    总重量: s.totalWeight.toFixed(2),
    总件数: s.totalCount.toFixed(2)
  }));

  summaryData.push({
    名称: '合计',
    规格: '',
    颜色: '',
    总重量: this.totalWeight.toFixed(2),
    总件数: this.totalCount.toFixed(2)
  });

  const wb = XLSX.utils.book_new();
  const recordSheet = XLSX.utils.json_to_sheet(enriched);
  const summarySheet = XLSX.utils.json_to_sheet(summaryData);

  XLSX.utils.book_append_sheet(wb, recordSheet, "出入库记录");
  XLSX.utils.book_append_sheet(wb, summarySheet, "统计汇总");

  XLSX.writeFile(wb, "出入库记录_含统计.xlsx");
},
    exportAll() {
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(this.products), "示例商品");
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(this.records), "出入库记录");
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(this.inventory), "库存盘点");
      XLSX.writeFile(wb, "进销存数据总表.xlsx");
    },
    importAll(event) {
      const file = event.target.files[0];
      const reader = new FileReader();
      reader.onload = (e) => {
        const wb = XLSX.read(e.target.result, { type: 'binary' });
        const productsSheet = wb.Sheets['示例商品'];
        const recordsSheet = wb.Sheets['出入库记录'];
        if (productsSheet) {
          const products = XLSX.utils.sheet_to_json(productsSheet);
          this.products = products.map(p => ({
            name: p.name, spec: p.spec, color: p.color, id: p.id || Date.now() + Math.random()
          }));
        }
        if (recordsSheet) {
          const records = XLSX.utils.sheet_to_json(recordsSheet);
          this.records = records.map(r => ({
            type: r.type,
            name: r.name,
            spec: r.spec,
            color: r.color,
            weight: r.weight,
            count: r.count,
            time: r.time,
            buyer: r.buyer || r["购买商家"] || ''
          }));
        }
        this.saveData();
        alert("数据导入成功！");
      };
      reader.readAsBinaryString(file);
    },
    editRecord(index) {
      const r = this.filteredRecords[index];
      const newWeight = prompt("修改重量：", r.weight);
      const newCount = prompt("修改件数：", r.count);
      const newTime = prompt("修改时间：", r.time);
      if (newWeight && newCount && newTime) {
        r.weight = newWeight;
        r.count = newCount;
        r.time = newTime;
        this.saveData();
      }
    },
    deleteRecord(index) {
      if (confirm("确认删除此记录？")) {
        const target = this.filteredRecords[index];
        const realIndex = this.records.findIndex(r => r === target);
        if (realIndex !== -1) {
          this.records.splice(realIndex, 1);
          this.saveData();
        }
      }
    },
    saveData() {
      localStorage.setItem('products', JSON.stringify(this.products));
      localStorage.setItem('records', JSON.stringify(this.records));
    }
  }
}).mount('#app');
</script>
</body>
</html>
